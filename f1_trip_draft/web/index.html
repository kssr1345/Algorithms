<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>F1 Travel Tracker</title>
  <style>
    :root { --bg:#0b1020; --panel:#121b34; --panel2:#1a2748; --text:#e8efff; --muted:#9bb0df; --accent:#ff4747; --ok:#22c55e; }
    * { box-sizing: border-box; }
    body { font-family: Inter, Arial, sans-serif; margin:0; color:var(--text); background: radial-gradient(circle at 10% 0%, #1b2452 0%, var(--bg) 45%); }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .hero { background: linear-gradient(135deg, #1e2a55, #10182f); border:1px solid #2c3f74; border-radius:16px; padding:20px; margin-bottom:16px; }
    .hero h1 { margin:0 0 8px; font-size: 30px; }
    .hero p { margin:0; color:var(--muted); }
    .grid { display:grid; grid-template-columns:1.2fr 1fr; gap:14px; }
    .card { background:linear-gradient(180deg, var(--panel), var(--panel2)); border:1px solid #2c3f74; border-radius:14px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.25); }
    .full { grid-column:1 / -1; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    h2 { margin:0 0 10px; font-size:20px; }
    label { display:block; margin:8px 0 4px; color:var(--muted); }
    input, select, button { width:100%; padding:10px; border-radius:10px; border:1px solid #3a4f86; background:#0f1a33; color:var(--text); }
    button { background: linear-gradient(135deg, #ff5c5c, var(--accent)); border:none; cursor:pointer; font-weight:700; }
    button:hover { transform: translateY(-1px); }
    button.secondary { background:#22345f; }
    .status { margin-top:8px; color:var(--muted); }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; margin-right:6px; background:#22345f; }
    .pill.ok { background: rgba(34,197,94,.2); color:#93f9b3; border:1px solid rgba(34,197,94,.45); }
    .pill.warn { background: rgba(255,200,0,.15); color:#fde68a; border:1px solid rgba(255,200,0,.4); }
    .drafts button { margin-bottom:8px; text-align:left; }
    .result { padding:12px; margin:10px 0; background:#0f1b37; border-radius:10px; border-left:4px solid var(--accent); }
    .mini { color:var(--muted); font-size:13px; }
    .loading { animation: pulse 1.2s infinite; }
    @keyframes pulse { 0%{opacity:.6;} 50%{opacity:1;} 100%{opacity:.6;} }
    @media (max-width: 900px) { .grid, .row { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="hero">
      <h1>üèÅ F1 Travel Tracker</h1>
      <p>Interactive trip planner with draft saving + live holiday/weather enrichment.</p>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Create trip draft</h2>
        <div class="row">
          <div>
            <label>Home airport</label>
            <input id="home_airport" value="LHR" />
          </div>
          <div>
            <label>Budget (EUR)</label>
            <input id="budget_eur" type="number" value="1200" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Travel style</label>
            <select id="style"><option>budget</option><option selected>balanced</option><option>premium</option></select>
          </div>
          <div>
            <label>Weather preference</label>
            <select id="weather_preference"><option>cool</option><option selected>mixed</option><option>warm</option></select>
          </div>
        </div>
        <button id="generate">Save Draft + Generate with Live Data</button>
        <div id="status" class="status"></div>
      </div>

      <div class="card drafts">
        <h2>Saved drafts</h2>
        <button id="refreshDrafts" class="secondary">Refresh drafts list</button>
        <div id="draftsList" class="mini">No drafts yet.</div>
      </div>

      <div class="card full">
        <h2>Live data status</h2>
        <div id="liveStatus" class="mini">No run yet.</div>
        <div id="context" class="mini" style="margin-top:8px;"></div>
      </div>

      <div class="card full">
        <h2>Top recommendations</h2>
        <div id="results" class="mini">No recommendations yet.</div>
      </div>
    </div>
  </div>

  <script>
    const statusNode = document.getElementById('status');
    const resultsNode = document.getElementById('results');
    const draftsListNode = document.getElementById('draftsList');
    const contextNode = document.getElementById('context');
    const liveStatusNode = document.getElementById('liveStatus');

    const totalCost = (item) => item.trip.flight_cost + item.trip.hotel_cost + item.trip.local_cost;

    function livePill(ok, label) {
      return `<span class="pill ${ok ? 'ok' : 'warn'}">${label}</span>`;
    }

    function renderContext(payload) {
      const summary = payload?.live_data_summary;
      const cityContext = payload?.city_context || [];
      if (summary) {
        const h = `${summary.holiday_live_cities}/${summary.total_cities} holiday live`;
        const w = `${summary.weather_live_cities}/${summary.total_cities} weather live`;
        liveStatusNode.innerHTML = `${livePill(summary.holiday_live_cities > 0, h)} ${livePill(summary.weather_live_cities > 0, w)} <span class="pill">Generated: ${new Date(summary.generated_at_utc).toLocaleString()}</span>`;
      } else {
        liveStatusNode.textContent = 'No live data summary available.';
      }

      contextNode.innerHTML = cityContext.map((c) => {
        const holiday = c.holiday ? `${c.holiday.localName} (${c.holiday.date})` : 'Holiday unavailable';
        const weather = c.weather ? `${c.weather.temp_c}¬∞C, rain ${Math.round(c.weather.rain_probability * 100)}%` : 'Weather unavailable';
        return `<div style="margin-bottom:6px;">${livePill(c.holiday_live, c.city + ' holiday')} ${livePill(c.weather_live, c.city + ' weather')} ${holiday} | ${weather}</div>`;
      }).join('');
    }

    function renderResults(data) {
      renderContext(data.context || {});
      const recs = data.recommendations || [];
      if (!recs.length) {
        resultsNode.innerHTML = '<p>No matching recommendations for this budget.</p>';
        return;
      }
      resultsNode.innerHTML = recs.slice(0, 3).map((item, i) => `
        <div class="result">
          <h3>${i + 1}. ${item.trip.name} (${item.trip.city}, ${item.trip.country})</h3>
          <div class="mini">Total ‚Ç¨${totalCost(item)} ‚Ä¢ Experience ${item.experience_score}/100 ‚Ä¢ Flight ‚Ç¨${item.trip.flight_cost} ‚Ä¢ Hotel ‚Ç¨${item.trip.hotel_cost}</div>
          <p>Save: ${item.save_tips[0]}</p>
          <p>Splurge: ${item.splurge_tips[0]}</p>
        </div>
      `).join('');
    }

    async function refreshDrafts() {
      const response = await fetch('/api/drafts');
      const payload = await response.json();
      const drafts = payload.drafts || [];
      if (!drafts.length) {
        draftsListNode.textContent = 'No drafts saved yet.';
        return;
      }
      draftsListNode.innerHTML = drafts.map((d) => `<button class="secondary" onclick="loadDraft(${d.id})">#${d.id} ‚Ä¢ ${d.input.home_airport || 'N/A'} ‚Ä¢ ‚Ç¨${d.input.budget_eur || '?'} ‚Ä¢ ${d.input.style || 'balanced'}</button>`).join('');
    }

    async function loadDraft(id) {
      statusNode.textContent = `Loading draft ${id}...`;
      let res = await fetch(`/api/recommendations/${id}`);
      let payload = await res.json();
      if (payload.error) {
        statusNode.textContent = `No saved recommendation for #${id}. Generating now...`;
        res = await fetch('/api/recommendations/generate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ draft_id:id }) });
        payload = await res.json();
      }
      renderResults(payload);
      statusNode.textContent = `Loaded draft ${id}.`;
    }

    document.getElementById('generate').addEventListener('click', async () => {
      statusNode.innerHTML = '<span class="loading">Saving draft + fetching live data...</span>';
      const payload = {
        home_airport: document.getElementById('home_airport').value,
        budget_eur: Number(document.getElementById('budget_eur').value),
        style: document.getElementById('style').value,
        weather_preference: document.getElementById('weather_preference').value,
      };
      const draftRes = await fetch('/api/drafts', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const draft = await draftRes.json();
      const recRes = await fetch('/api/recommendations/generate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ draft_id:draft.draft_id }) });
      const recData = await recRes.json();
      renderResults(recData);
      statusNode.textContent = `Done. Draft #${draft.draft_id} generated.`;
      await refreshDrafts();
    });

    document.getElementById('refreshDrafts').addEventListener('click', refreshDrafts);
    window.loadDraft = loadDraft;
    refreshDrafts();
  </script>
</body>
</html>
